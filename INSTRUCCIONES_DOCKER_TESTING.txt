===============================================================================
            INSTRUCCIONES PARA PROBAR DOCKER COMPOSE - API REST
===============================================================================

üìÅ DIRECTORIO DE TRABAJO
===============================================================================
Todas las operaciones se ejecutan desde el directorio ra√≠z del proyecto:
‚îî‚îÄ‚îÄ PruebaProgramadorBackendCSharp/

‚ö†Ô∏è IMPORTANTE: Aseg√∫rate de estar en el directorio correcto antes de ejecutar comandos.

üîß REQUISITOS PREVIOS
===============================================================================
1. Docker instalado y funcionando
2. Docker Compose instalado
3. Puertos 5432 (PostgreSQL) y 8080 (API) disponibles

Para verificar Docker:
> docker --version
> docker-compose --version

===============================================================================
                        üöÄ PASOS PARA PROBAR DOCKER
===============================================================================

PASO 1: NAVEGAR AL DIRECTORIO CORRECTO
===============================================================================
Ejecutar desde tu terminal:

> cd /ruta/al/proyecto/PruebaProgramadorBackendCSharp

O si ya est√°s en el proyecto:
> pwd
Deber√≠as ver: /ruta/al/proyecto/PruebaProgramadorBackendCSharp


PASO 2: VERIFICAR ARCHIVOS DOCKER
===============================================================================
Verificar que existen los archivos necesarios:

> ls -la
Debes ver:
- docker-compose.yml ‚úì
- Dockerfile ‚úì
- init-scripts/ ‚úì
- PruebaProgramadorBackendCSharp/ ‚úì


PASO 3: LIMPIAR CONTENEDORES PREVIOS (OPCIONAL)
===============================================================================
Si has ejecutado el proyecto antes, limpia los contenedores:

> docker-compose down -v
> docker system prune -f

RESULTADO ESPERADO:
- Mensaje: "Network prueba-network removed" o similar
- No errores importantes


PASO 4: CONSTRUIR Y EJECUTAR LOS SERVICIOS
===============================================================================
Ejecutar el comando principal:

> docker-compose up -d --build

RESULTADO ESPERADO:
‚úì Building api-rest...
‚úì Creating network "prueba-network"
‚úì Creating volume "prueba_postgres_data"
‚úì Creating prueba_postgres_db... done
‚úì Creating prueba_api_rest... done

Tiempo estimado: 2-5 minutos (primera vez)


PASO 5: VERIFICAR ESTADO DE LOS SERVICIOS
===============================================================================
Verificar que los contenedores est√°n ejecut√°ndose:

> docker-compose ps

RESULTADO ESPERADO:
NAME                  COMMAND                  SERVICE             STATUS
prueba_api_rest       "dotnet PruebaProg..."   api-rest           Up (healthy)
prueba_postgres_db    "docker-entrypoint..."   postgres-db        Up (healthy)

‚ö†Ô∏è Estado "healthy" puede tardar 1-2 minutos en aparecer.

üîç SI VES "unhealthy" EN LA API:
===============================================================================
Si el API aparece como "Up (unhealthy)", esto indica que la aplicaci√≥n no est√° 
respondiendo correctamente. El problema m√°s com√∫n es que las migraciones de base 
de datos no se aplicaron autom√°ticamente.

üîß SOLUCI√ìN R√ÅPIDA:
> docker-compose down
> docker-compose up -d --build

1. Verificar logs de la API para diagn√≥stico:
> docker-compose logs api-rest

ERRORES COMUNES EN LOGS:
- "Unable to connect to database" ‚Üí PostgreSQL no est√° listo a√∫n
- "Migration error" ‚Üí Problemas con migraciones de Entity Framework
- "ResourceInvoker error" ‚Üí Error de inicializaci√≥n de la aplicaci√≥n

2. Verificar que PostgreSQL est√° healthy:
> docker-compose ps

3. Si persiste el problema, verificar conectividad manual:
> curl -X GET http://localhost:8080/api/MarcasAutos

4. Verificar health check espec√≠fico:
> docker inspect prueba_api_rest | grep -A 5 '"Health"'

‚ö†Ô∏è IMPORTANTE: La aplicaci√≥n ahora aplica migraciones autom√°ticamente al iniciar,
   pero esto puede tardar 30-60 segundos la primera vez.


PASO 6: VERIFICAR LOGS DE LOS SERVICIOS
===============================================================================
Para ver logs de la API:
> docker-compose logs api-rest

RESULTADO ESPERADO:
‚úì "Now listening on: http://[::]:80"
‚úì "Application started. Press Ctrl+C to shut down."
‚úì Sin errores de conexi√≥n a base de datos

Para ver logs de PostgreSQL:
> docker-compose logs postgres-db

RESULTADO ESPERADO:
‚úì "database system is ready to accept connections"
‚úì "Base de datos prueba_db inicializada correctamente"


PASO 7: PROBAR LA API REST
===============================================================================
Opci√≥n A - Navegador Web:
Abrir en el navegador: http://localhost:8080/api/MarcasAutos

Opci√≥n B - Comando curl:
> curl -X GET http://localhost:8080/api/MarcasAutos

RESULTADO ESPERADO:
- C√≥digo de respuesta: 200 OK
- Respuesta JSON: [] (array vac√≠o si no hay datos)
- Sin errores de conexi√≥n


PASO 8: PROBAR ENDPOINTS PRINCIPALES
===============================================================================
Obtener todas las marcas:
> curl -X GET http://localhost:8080/api/MarcasAutos

Crear una nueva marca:
> curl -X POST http://localhost:8080/api/MarcasAutos \
  -H "Content-Type: application/json" \
  -d '{"nombre":"Toyota","activo":true}'

Obtener marca por ID (reemplazar {id} con ID real):
> curl -X GET http://localhost:8080/api/MarcasAutos/{id}

RESULTADOS ESPERADOS:
- GET: C√≥digo 200, lista de marcas
- POST: C√≥digo 201, marca creada
- GET por ID: C√≥digo 200, marca espec√≠fica


PASO 9: VERIFICAR BASE DE DATOS POSTGRESQL
===============================================================================
Conectar a PostgreSQL:
> docker exec -it prueba_postgres_db psql -U postgres -d prueba_db

Dentro de PostgreSQL, ejecutar:
prueba_db=# \dt
prueba_db=# SELECT * FROM "MarcasAutos";
prueba_db=# \q

RESULTADO ESPERADO:
‚úì Tabla "MarcasAutos" existe
‚úì Datos insertados se muestran correctamente
‚úì Conexi√≥n exitosa


PASO 10: HEALTH CHECKS
===============================================================================
Verificar health checks de los servicios:

> docker inspect prueba_api_rest | grep -A 10 '"Health"'
> docker inspect prueba_postgres_db | grep -A 10 '"Health"'

RESULTADO ESPERADO:
- "Status": "healthy" para ambos servicios


===============================================================================
                        üõ†Ô∏è COMANDOS √öTILES ADICIONALES
===============================================================================

MONITOREO EN TIEMPO REAL:
> docker-compose logs -f                    # Ver logs en tiempo real
> docker stats                              # Ver uso de recursos

DEBUGGING:
> docker-compose exec api-rest bash         # Acceder al contenedor de la API
> docker-compose exec postgres-db bash      # Acceder al contenedor de PostgreSQL

REINICIAR SERVICIOS:
> docker-compose restart                    # Reiniciar todos los servicios
> docker-compose restart api-rest           # Reiniciar solo la API

DETENER SERVICIOS:
> docker-compose stop                       # Detener servicios
> docker-compose down                       # Detener y eliminar contenedores
> docker-compose down -v                    # Incluir vol√∫menes


===============================================================================
                        ‚ùå SOLUCI√ìN DE PROBLEMAS
===============================================================================

PROBLEMA: Puerto 8080 ya est√° en uso
SOLUCI√ìN: 
> netstat -tulpn | grep :8080
> kill -9 <PID_del_proceso>

PROBLEMA: Puerto 5432 ya est√° en uso (PostgreSQL local)
SOLUCI√ìN: 
> sudo systemctl stop postgresql
O cambiar puerto en docker-compose.yml: "5433:5432"

PROBLEMA: Error "no space left on device"
SOLUCI√ìN:
> docker system prune -a -f
> docker volume prune -f

PROBLEMA: API aparece como "unhealthy" en docker-compose ps
SOLUCI√ìN:
1. ‚ö° CAUSA COM√öN: Migraciones de base de datos no aplicadas
   > docker-compose logs api-rest
   (Buscar errores de "ResourceInvoker" o "Migration")
   
2. SOLUCI√ìN AUTOM√ÅTICA (implementada en la √∫ltima versi√≥n):
   - La aplicaci√≥n ahora aplica migraciones autom√°ticamente al iniciar
   - Puede tardar 40-60 segundos en la primera ejecuci√≥n
   
3. Si persiste el problema:
   > docker-compose down
   > docker-compose up -d --build
   
4. Verificar respuesta manual:
   > curl http://localhost:8080/api/MarcasAutos
   
5. Ver detalles del health check:
   > docker inspect prueba_api_rest | grep -A 10 '"Health"'

PROBLEMA: API no responde (504 Gateway Timeout)
SOLUCI√ìN:
1. Verificar logs: docker-compose logs api-rest
2. Verificar health check de PostgreSQL
3. Reiniciar servicios: docker-compose restart

PROBLEMA: Error de migraci√≥n de base de datos
SOLUCI√ìN:
> docker-compose down -v
> docker-compose up -d --build


===============================================================================
                        ‚úÖ RESULTADOS EXITOSOS FINALES
===============================================================================

Al completar todos los pasos, deber√≠as tener:

1. ‚úì Dos contenedores ejecut√°ndose correctamente
2. ‚úì API REST accesible en http://localhost:8080
3. ‚úì PostgreSQL funcionando en puerto 5432
4. ‚úì Health checks mostrando estado "healthy"
5. ‚úì Endpoints de la API respondiendo correctamente
6. ‚úì Base de datos creada y accesible

URLs IMPORTANTES:
- API REST: http://localhost:8080/api/MarcasAutos
- Documentaci√≥n Swagger: http://localhost:8080/swagger (si est√° habilitado)

===============================================================================
                        üìû INFORMACI√ìN DE CONTACTO
===============================================================================

Si encuentras problemas no cubiertos en esta gu√≠a:
1. Revisa los logs con: docker-compose logs
2. Verifica que Docker est√© funcionando: docker --version
3. Aseg√∫rate de estar en el directorio correcto
4. Verifica que los puertos no est√©n ocupados

¬°Happy Testing! üê≥üöÄ
===============================================================================